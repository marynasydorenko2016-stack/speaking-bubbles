<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Speaking Bubbles</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eef6ff;
  overflow: hidden;
}

/* ---------- SETUP ---------- */
#setup {
  padding: 20px;
  text-align: center;
}

textarea {
  width: 420px;
  height: 150px;
}

input, textarea, select, button {
  font-size: 18px;
  margin: 8px;
}

#imagePreview {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}

.image-wrap {                    /* NEW */
  position: relative;
  display: inline-block;
}

.image-wrap img {
  width: 70px;
  height: 70px;
  object-fit: contain;
  margin: 5px;
  border-radius: 10px;
  box-shadow: 0 0 6px rgba(0,0,0,0.25);
}

.image-wrap button {             /* NEW */
  position: absolute;
  top: -6px;
  right: -6px;
  border: none;
  background: #ff4d4d;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  cursor: pointer;
  font-size: 14px;
  line-height: 18px;
}

/* ---------- GAME ---------- */
#game {
  display: none;
  text-align: center;
}

#container {
  position: relative;
  width: 100vw;
  height: 80vh;
  overflow: hidden;
}

/* ---------- BUBBLE ---------- */
.bubble {
  position: absolute;
  border-radius: 50%;
  cursor: grab;
  user-select: none;
  z-index: 5;
  background:
    radial-gradient(circle at 30% 30%,
      rgba(255,255,255,0.95),
      rgba(160,210,255,0.35) 60%,
      rgba(120,170,220,0.25)
    );
  box-shadow:
    inset -1px -1px 4px rgba(255,255,255,0.5),
    inset 1px 1px 4px rgba(120,170,220,0.25),
    0 6px 14px rgba(0,0,0,0.15);
}

/* ---------- SAFE ---------- */
.safe {
  position: absolute;
  inset: 22%;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.bubble-text {
  font-weight: bold;
  color: #003366;
  text-align: center;
  line-height: 1.35;
}

.safe img {
  width: 115%;
  height: 115%;
  object-fit: contain;
  pointer-events: none;
}

/* ---------- SMALL ---------- */
.small {
  position: absolute;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background:
    radial-gradient(circle at 30% 30%,
      rgba(255,255,255,0.9),
      rgba(170,220,255,0.6)
    );
  pointer-events: none;
}

/* ---------- BUTTON ---------- */
#againBtn {
  display: none;
  font-size: 20px;
  margin-top: 10px;
}
</style>
</head>

<body>

<!-- ===== TEACHER SETUP ===== -->
<div id="setup">
  <h2>Teacher setup</h2>

  <input id="editLink" placeholder="Paste student link to edit" style="width:420px"><br>
  <button onclick="loadFromLink()">üìÇ Load activity</button>
  <hr style="width:60%; margin:20px auto">

  <input id="instruction" value="Move, read, speak!" style="width:420px"><br>
  <textarea id="phrases" placeholder="One phrase per line"></textarea><br>

  <label>Bubble size:
    <select id="bubbleSize">
      <option value="160">Small</option>
      <option value="200" selected>Medium</option>
      <option value="240">Large</option>
    </select>
  </label><br>

  <button onclick="addImage()">‚ûï Add image</button>
  <div id="imagePreview"></div><br>

  <button onclick="saveLink()">üíæ Save activity & get student link</button>
  <p id="linkBox"></p>
</div>

<!-- ===== GAME ===== -->
<div id="game">
  <h2 id="instructionText"></h2>
  <div id="container"></div>
  <button id="againBtn" onclick="restart()">üîÅ Again</button>
</div>

<audio id="popSound">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-bubble-pop-up-1686.wav">
</audio>

<script>
const container = document.getElementById("container");
const popSound = document.getElementById("popSound");

let SIZE = 200, R = 100;
let bubbles = [], smalls = [], images = [];
let active = null, ox = 0, oy = 0;
let savedPhrases = [];

const gravity = 0.45;
const drift = 0.12;

/* ---------- IMAGE PREVIEW RENDER (NEW) ---------- */
function renderImagePreview() {
  imagePreview.innerHTML = "";
  images.forEach((src, index) => {
    const wrap = document.createElement("div");
    wrap.className = "image-wrap";

    const img = document.createElement("img");
    img.src = src;

    const del = document.createElement("button");
    del.textContent = "√ó";
    del.onclick = () => {
      images.splice(index, 1);
      renderImagePreview();
    };

    wrap.appendChild(img);
    wrap.appendChild(del);
    imagePreview.appendChild(wrap);
  });
}

/* ---------- LOAD FROM LINK ---------- */
function loadFromLink() {
  try {
    const url = new URL(editLink.value.trim());
    const encoded = url.searchParams.get("play");
    if (!encoded) return alert("Invalid student link");

    const data = JSON.parse(
      decodeURIComponent(escape(atob(encoded)))
    );

    instruction.value = data.instruction || "";
    phrases.value = data.phrases || "";
    bubbleSize.value = data.size || "200";
    images = data.images || [];
    renderImagePreview();
  } catch {
    alert("Invalid student link");
  }
}

/* ---------- ADD IMAGE ---------- */
function addImage() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      images.push(e.target.result);
      renderImagePreview();
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

/* ---------- SAVE LINK ---------- */
function saveLink() {
  const data = {
    instruction: instruction.value,
    phrases: phrases.value,
    size: bubbleSize.value,
    images
  };
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  const url = location.origin + location.pathname + "?play=" + encoded;
  linkBox.innerHTML =
    "Student link:<br><a href='" + url + "' target='_blank'>" + url + "</a>";
}

/* ---------- STUDENT MODE ---------- */
const params = new URLSearchParams(location.search);
if (params.has("play")) {
  setup.style.display = "none";
  game.style.display = "block";

  const data = JSON.parse(
    decodeURIComponent(escape(atob(params.get("play"))))
  );

  instructionText.textContent = data.instruction;
  SIZE = +data.size;
  R = SIZE / 2;
  images = data.images || [];
  savedPhrases = data.phrases.split("\n").map(t => t.trim()).filter(Boolean);

  savedPhrases.forEach(createTextBubble);
  images.forEach(createImageBubble);
}

/* ---------- RESTART ---------- */
function restart() {
  container.innerHTML = "";
  bubbles = [];
  smalls = [];
  againBtn.style.display = "none";
  savedPhrases.forEach(createTextBubble);
  images.forEach(createImageBubble);
}

/* ---------- CREATE BUBBLES ---------- */
function createTextBubble(text) {
  const b = createBaseBubble();
  const safe = document.createElement("div");
  safe.className = "safe";
  const t = document.createElement("div");
  t.className = "bubble-text";
  t.textContent = text;
  safe.appendChild(t);
  b.appendChild(safe);
  container.appendChild(b);
  bubbles.push(b);
}

function createImageBubble(src) {
  const b = createBaseBubble();
  const safe = document.createElement("div");
  safe.className = "safe";
  const img = document.createElement("img");
  img.src = src;
  safe.appendChild(img);
  b.appendChild(safe);
  container.appendChild(b);
  bubbles.push(b);
}

function createBaseBubble() {
  const b = document.createElement("div");
  b.className = "bubble";
  b.style.width = b.style.height = SIZE + "px";
  b.x = Math.random() * (container.clientWidth - SIZE);
  b.y = Math.random() * 120;
  b.vx = (Math.random() - 0.5) * drift;
  b.vy = gravity;

  b.onmousedown = e => {
    active = b;
    ox = e.offsetX;
    oy = e.offsetY;
    b.vx = b.vy = 0;
  };

  b.ondblclick = () => burst(b);
  return b;
}

/* ---------- BURST ---------- */
function burst(b) {
  popSound.currentTime = 0;
  popSound.play().catch(()=>{});
  for (let i = 0; i < 9; i++) {
    const s = document.createElement("div");
    s.className = "small";
    s.x = b.x + R;
    s.y = b.y + R;
    s.vx = (Math.random() - 0.5) * 1.6;
    s.vy = (Math.random() - 0.5) * 1.6;
    container.appendChild(s);
    smalls.push(s);
  }
  container.removeChild(b);
  bubbles.splice(bubbles.indexOf(b), 1);
  if (!bubbles.length)
    againBtn.style.display = "inline-block";
}

/* ---------- DRAG ---------- */
document.onmousemove = e => {
  if (!active) return;
  active.x = Math.max(0, Math.min(container.clientWidth - SIZE, e.pageX - ox));
  active.y = Math.max(0, Math.min(container.clientHeight - SIZE, e.pageY - oy - container.offsetTop));
};

document.onmouseup = () => {
  if (active) {
    active.vx = (Math.random() - 0.5) * drift;
    active.vy = gravity;
  }
  active = null;
};

/* ---------- COLLISION + ANIMATION ---------- */
function resolveCollisions() {
  for (let i = 0; i < bubbles.length; i++)
    for (let j = i + 1; j < bubbles.length; j++) {
      const a = bubbles[i], b = bubbles[j];
      const dx = (a.x + R) - (b.x + R);
      const dy = (a.y + R) - (b.y + R);
      const dist = Math.hypot(dx, dy);
      if (dist < SIZE && dist > 0) {
        const nx = dx / dist, ny = dy / dist;
        const overlap = (SIZE - dist) / 2;
        a.x += nx * overlap;
        a.y += ny * overlap;
        b.x -= nx * overlap;
        b.y -= ny * overlap;
      }
    }
}

function animate() {
  resolveCollisions();

  bubbles.forEach(b => {
    if (b !== active) {
      b.vy += gravity * 0.02;
      b.x += b.vx;
      b.y += b.vy;
    }

    b.x = Math.max(0, Math.min(container.clientWidth - SIZE, b.x));
    b.y = Math.max(0, Math.min(container.clientHeight - SIZE, b.y));

    b.style.left = b.x + "px";
    b.style.top = b.y + "px";
  });

  smalls.forEach(s => {
    s.x += s.vx;
    s.y += s.vy;
    s.style.left = s.x + "px";
    s.style.top = s.y + "px";
  });

  requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
