<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Speaking Bubbles</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eef6ff;
  overflow: hidden;
}

/* ---------- SETUP ---------- */
#setup {
  padding: 20px;
  text-align: center;
}

textarea {
  width: 420px;
  height: 150px;
}

input, textarea, select, button {
  font-size: 18px;
  margin: 8px;
}

#imagePreview img {
  width: 70px;
  height: 70px;
  object-fit: contain;
  margin: 5px;
  border-radius: 10px;
  box-shadow: 0 0 6px rgba(0,0,0,0.25);
  cursor: pointer;
}

/* ---------- GAME ---------- */
#game {
  display: none;
  text-align: center;
}

#container {
  position: relative;
  width: 100vw;
  height: 80vh;
  overflow: hidden;
}

/* ---------- BUBBLE ---------- */
.bubble {
  position: absolute;
  border-radius: 50%;
  cursor: grab;
  user-select: none;
  z-index: 5;
  background:
    radial-gradient(circle at 30% 30%,
      rgba(255,255,255,0.95),
      rgba(160,210,255,0.35) 60%,
      rgba(120,170,220,0.25)
    );
  box-shadow:
    inset -1px -1px 4px rgba(255,255,255,0.5),
    inset 1px 1px 4px rgba(120,170,220,0.25),
    0 6px 14px rgba(0,0,0,0.15);
}

/* ---------- SAFE ---------- */
.safe {
  position: absolute;
  inset: 22%;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.bubble-text {
  font-weight: bold;
  color: #003366;
  text-align: center;
  line-height: 1.35;
}

.safe img {
  width: 115%;
  height: 115%;
  object-fit: contain;
  pointer-events: none;
}

/* ---------- SMALL ---------- */
.small {
  position: absolute;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background:
    radial-gradient(circle at 30% 30%,
      rgba(255,255,255,0.9),
      rgba(170,220,255,0.6)
    );
  pointer-events: none;
}

/* ---------- BUTTON ---------- */
#againBtn {
  display: none;
  font-size: 20px;
  margin-top: 10px;
}
</style>
</head>

<body>

<!-- ===== TEACHER SETUP ===== -->
<div id="setup">
  <h2>Teacher setup</h2>

  <input id="instruction" value="Move, read, speak!" style="width:420px"><br>

  <textarea id="phrases" placeholder="One phrase per line"></textarea><br>

  <label>Bubble size:
    <select id="bubbleSize">
      <option value="160">Small</option>
      <option value="200" selected>Medium</option>
      <option value="240">Large</option>
    </select>
  </label><br>

  <button onclick="addImage()">‚ûï Add image</button>
  <div id="imagePreview"></div><br>

  <hr>

  <h3>Edit existing activity</h3>
  <input id="editId" placeholder="activity-001" style="width:200px">
  <button onclick="loadActivity()">Load</button>

  <hr>

  <button onclick="saveActivity()">üíæ Save activity</button>
  <p id="linkBox"></p>
</div>

<!-- ===== GAME ===== -->
<div id="game">
  <h2 id="instructionText"></h2>
  <div id="container"></div>
  <button id="againBtn" onclick="restart()">üîÅ Again</button>
</div>

<audio id="popSound">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-bubble-pop-up-1686.wav">
</audio>

<script>
const container = document.getElementById("container");
const popSound = document.getElementById("popSound");

let SIZE = 200, R = 100;
let bubbles = [], smalls = [], images = [];
let active = null, ox = 0, oy = 0;
let currentActivityId = null;

const gravity = 0.45;
const drift = 0.12;

/* ---------- IMAGE ---------- */
function addImage() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      images.push(e.target.result);
      renderImagePreview();
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function renderImagePreview() {
  const box = document.getElementById("imagePreview");
  box.innerHTML = "";
  images.forEach((src, i) => {
    const img = document.createElement("img");
    img.src = src;
    img.title = "Click to delete";
    img.onclick = () => {
      images.splice(i, 1);
      renderImagePreview();
    };
    box.appendChild(img);
  });
}

/* ---------- SAVE ---------- */
function saveActivity() {
  const id = currentActivityId || "activity-" + Date.now();
  currentActivityId = id;

  const data = {
    instruction: instruction.value,
    phrases: phrases.value,
    size: bubbleSize.value,
    images
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = id + ".json";
  a.click();

  const url = location.origin + location.pathname + "?play=" + id;
  linkBox.innerHTML =
    "Upload the downloaded file to <b>activities/</b><br>Student link:<br>" +
    "<a href='"+url+"' target='_blank'>"+url+"</a>";
}

/* ---------- LOAD ---------- */
function loadActivity() {
  const id = editId.value.trim();
  if (!id) return alert("Enter activity id");

  fetch("activities/" + id + ".json")
    .then(r => r.json())
    .then(data => {
      currentActivityId = id;
      instruction.value = data.instruction;
      phrases.value = data.phrases;
      bubbleSize.value = data.size;
      images = data.images || [];
      renderImagePreview();
    })
    .catch(() => alert("Activity not found"));
}

/* ---------- STUDENT MODE ---------- */
const params = new URLSearchParams(location.search);
if (params.has("play")) {
  const id = params.get("play");
  fetch("activities/" + id + ".json")
    .then(r => r.json())
    .then(data => {
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      instructionText.textContent = data.instruction;
      SIZE = +data.size;
      R = SIZE / 2;
      images = data.images || [];

      data.phrases.split("\n").map(t=>t.trim()).filter(Boolean)
        .forEach(createTextBubble);
      images.forEach(createImageBubble);
    })
    .catch(() => alert("Activity not found"));
}

/* ---------- GAME ---------- */
function restart() {
  container.innerHTML = "";
  bubbles = [];
  smalls = [];
  document.getElementById("againBtn").style.display = "none";

  phrases.value.split("\n").map(t=>t.trim()).filter(Boolean)
    .forEach(createTextBubble);
  images.forEach(createImageBubble);
}

function createTextBubble(text) {
  const b = createBaseBubble();
  const safe = document.createElement("div");
  safe.className = "safe";
  const t = document.createElement("div");
  t.className = "bubble-text";
  t.textContent = text;
  safe.appendChild(t);
  b.appendChild(safe);
  container.appendChild(b);
  bubbles.push(b);
}

function createImageBubble(src) {
  const b = createBaseBubble();
  const safe = document.createElement("div");
  safe.className = "safe";
  const img = document.createElement("img");
  img.src = src;
  safe.appendChild(img);
  b.appendChild(safe);
  container.appendChild(b);
  bubbles.push(b);
}

function createBaseBubble() {
  const b = document.createElement("div");
  b.className = "bubble";
  b.style.width = b.style.height = SIZE + "px";
  b.x = Math.random() * (container.clientWidth - SIZE);
  b.y = Math.random() * 120;
  b.vx = (Math.random() - 0.5) * drift;
  b.vy = gravity;

  b.onmousedown = e => {
    active = b;
    ox = e.offsetX;
    oy = e.offsetY;
    b.vx = b.vy = 0;
  };

  b.ondblclick = () => burst(b);
  return b;
}

function burst(b) {
  popSound.currentTime = 0;
  popSound.play().catch(()=>{});
  for (let i = 0; i < 9; i++) {
    const s = document.createElement("div");
    s.className = "small";
    s.x = b.x + R;
    s.y = b.y + R;
    s.vx = (Math.random() - 0.5) * 1.6;
    s.vy = (Math.random() - 0.5) * 1.6;
    container.appendChild(s);
    smalls.push(s);
  }
  container.removeChild(b);
  bubbles.splice(bubbles.indexOf(b), 1);
  if (!bubbles.length)
    document.getElementById("againBtn").style.display = "inline-block";
}

/* ---------- DRAG ---------- */
document.onmousemove = e => {
  if (!active) return;
  active.x = Math.max(0, Math.min(container.clientWidth - SIZE, e.pageX - ox));
  active.y = Math.max(0, Math.min(container.clientHeight - SIZE, e.pageY - oy - container.offsetTop));
};
document.onmouseup = () => active = null;

/* ---------- ANIMATE ---------- */
function animate() {
  bubbles.forEach(b => {
    if (b !== active) {
      b.vy += gravity * 0.02;
      b.x += b.vx;
      b.y += b.vy;
      if (b.x <= 0 || b.x >= container.clientWidth - SIZE) b.vx *= -1;
      if (b.y > container.clientHeight - SIZE) {
        b.y = container.clientHeight - SIZE;
        b.vy *= -0.4;
      }
    }
    b.style.left = b.x + "px";
    b.style.top = b.y + "px";
  });
  smalls.forEach(s => {
    s.x += s.vx;
    s.y += s.vy;
    s.style.left = s.x + "px";
    s.style.top = s.y + "px";
  });
  requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
